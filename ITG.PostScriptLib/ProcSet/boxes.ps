%!PS-Adobe-3.0
%%Creator: Sergey S. Betke <sergey.s.betke@yandex.ru>
%%Copyright: 2018 Sergey S. Betke <sergey.s.betke@yandex.ru>
%%+ See LICENSE at https://github.com/Metrolog/marks
%%DocumentData: Clean7Bit
%%DocumentSuppliedResources: ProcSet (boxes)
%%Version: 2.2 0
%%EndComments
%%BeginProlog

%(boxes) /ProcSet resourcestatus { pop pop } {
%!PS-Adobe-3.0 Resource-ProcSet
%%BeginResource: ProcSet (boxes)
/boxes <<

/GetPageBBox
{
  currentpagedevice /ImagingBBox get
  dup type /nulltype eq
    {
      pop
        0 0
        currentpagedevice /PageSize get  aload  pop
        4 array
      astore
    }
  if
} bind

/rotate_to_zero
{
  matrix currentmatrix
  aload pop pop pop pop pop % --> a b
  exch % --> b a
  atan % угол поворота исходной матрицы
  neg rotate % развернули исходную матрицу, чтобы исключить поворот
} bind

/size_of_BBox % [ x1 y1 x2 y2 ] --> x2-x1  y2-y1
{
  dup type  /arraytype  eq  { aload pop } if
  exch  3 1 roll
  sub neg
  3 1 roll
  sub neg
  exch
} bind

/size_of_BBox_def % /sizeX /sizeY [ x1 y1 x2 y2 ] --> - ; /sizeX = x2-x1; /sizeY = y2-y1;
{
  size_of_BBox
  3 -1 roll exch def
  def
} bind

/upath_BBox % upath --> x1 y1 x2 y2
{
  matrix currentmatrix
    rotate_to_zero
    exch % upath
    gsave
      newpath
      0 0 moveto
      uappend flattenpath pathbbox
    grestore
    5 -1 roll
  setmatrix
} bind

/string_BBox % string --> x1 y1 x2 y2
{
  matrix currentmatrix
    rotate_to_zero
    exch % string
    gsave
      newpath
      0 0 moveto
      false charpath pathbbox
    grestore
    5 -1 roll
  setmatrix
} bind

>> /ProcSet defineresource pop
%%EndResource:
%} ifelse

%%EndProlog
